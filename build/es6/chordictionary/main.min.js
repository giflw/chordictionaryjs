import{WORDING}from"./wordings";import*as SCALE from"./scales";import*as CHORD from"./chords";import*as TUNING from"./tuning";import*as TAB from"./tab";import*as PARSER from"./parser";import*as TOOLS from"./tools";class Instrument{constructor(t,e,r,o){try{TUNING.isValid(t)&&(this.tuning=PARSER.splitTuning(t)),this.fretNumber=e,this.fretsToDisplay=isNaN(r)?0:r+1,this.maxSpan=isNaN(o)?4:o}catch(t){return console.error(t),!1}return this}getChordInfo(t){let e=[],r=[],o=[],i={error:"",name:"",tab:t,notes:"",tuning:this.tuning.join(""),formula:""};try{TAB.isValid(t)&&(t=PARSER.splitTab(t))}catch(t){return i.error=t,i}try{e=TAB.toNotes(t,this.tuning),i.notes=e.join("")}catch(t){return i.error=WORDING.failedToConvertTabIntoNotes,i}let n=[];try{for(let t=0;t<this.tuning.length;t++)if(n.push({root:"",formula:[]}),e[t]&&"x"!==e[t].toLowerCase())for(let r=0;r<e.length;r++){if(!e[r]||"x"===e[r].toLowerCase())continue;let o=SCALE.A.indexOf(e[r])-SCALE.A.indexOf(e[t]);o<0?o=SCALE.A.length+o:0===o&&(n[t].root=e[r]),n[t].formula.push(o)}}catch(t){i.error=WORDING.failedToCalculateFormula}for(let t=0;t<n.length;t++){if(""===n[t].root)continue;o.push(n[t].root),n[t].formula.sort(function(t,e){return t-e});let e=TOOLS.removeDuplicates(n[t].formula);r.push(e.join("-"))}let s,l,a=[],h=[];try{for(let t=0;t<CHORD.FORMULAS.length;t++){s=CHORD.FORMULAS[t].integer;for(let e=0;e<r.length;e++)l=new RegExp("^"+r[e]+"$","g"),s.match(l)&&o[e]&&(h.push(o[e]+CHORD.FORMULAS[t].suffix),a.push(CHORD.FORMULAS[t].formula))}if(!(a.length>0))throw WORDING.noMatch;if(a.length>1){let t=TOOLS.removeDuplicates(a);i.formula=t}else i.formula=a}catch(t){return i.error=t,i}if(h.length>1){let t=TOOLS.removeDuplicates(h);i.name=t}else i.name=h;return i}getChordsList(t,e,r){r=r||0;let o,i,n,s,l=[],a=[],h={error:"",chordList:[],offset:0};const f={basic:{rootBelow4thFret:!0,noMuteAfterFirstNote:!0,rootIsLowestNote:!0,splittedChord:!1,openString:!0},powerchord:{frettedNotes:[2,3],rootIsLowestNote:!0,rootOnLowestFret:!0,splittedChord:!1,openString:!1},bar:{rootIsLowestNote:!0,rootOnLowestFret:!0,barredString:[3,6],noMuteAfterFirstNote:!0,splittedChord:!1,openString:!1}};try{if("string"!=typeof t)throw WORDING.invalidChordName;n=(t=PARSER.splitChordName(t))[0],o=t[1],l.push(n),s=SCALE.A.indexOf(n),a=(i=TOOLS.searchInObject(CHORD.FORMULAS,o)).integer.split("-")}catch(t){return h.error=WORDING.invalidChordName,h}for(let t=1;t<a.length;t++){let e=parseInt(a[t])+parseInt(s);e>SCALE.A.length-1&&(e-=SCALE.A.length),l.push(SCALE.A[e])}let u,d=[],p=0;for(p=0;p<this.tuning.length;p++){d[p]=[],d[p].push("x");for(let t=0;t<l.length;t++)(u=SCALE.A.indexOf(l[t])-SCALE.A.indexOf(this.tuning[p]))<0&&(u=SCALE.A.length+u),d[p].push(u),u+12<this.fretNumber&&d[p].push(u+12)}let g=[];for(p=0;p<this.tuning.length;p++){let t=g.length;for(let e=0;e<d[p].length;e++)if(g[e])for(let r=0;r<t;r++)if(0===e)g[r].push(d[p][e]);else{let t=g[r].slice(0);t.pop(),t.push(d[p][e]),g.push(t)}else g[e]=[d[p][e]]}let c=[],O=(t,e)=>{for(let r in t){if(!e.hasOwnProperty(r))return!1;if("object"==typeof t[r]){let o=t[r][0],i=t[r][1];if(e[r]<o||e[r]>i)return!1}else if(e[r]!==t[r])return!1}return!0};try{for(let t=r;t<g.length;t++){if(CHORD.isValid(g[t],l,this.tuning)&&TOOLS.arrayFind(g[t],"max")-TOOLS.arrayFind(g[t],"min")<this.maxSpan){let e={openString:!1,frettedNotes:0},r=g[t].join(""),o=/[0-9]+[x]+/gi;/[0-9]+[x]+[0-9]+/gi.test(r)?e.splittedChord=!0:e.splittedChord=!1,o.test(r)?e.noMuteAfterFirstNote=!1:e.noMuteAfterFirstNote=!0;for(let r=0;r<g[t].length;r++){let o=g[t][r];if(!isNaN(o)){let i=o+SCALE.A.indexOf(this.tuning[r]);0===o&&(e.openString=!0),s===i&&(0===e.frettedNotes&&(e.rootIsLowestNote=!0),e.rootBelow4thFret=o<=4,e.rootOnLowestFret=TOOLS.arrayFind(g[t],"min")>=o),(o>0&&r<g[t].length-1&&o===g[t][r-1]||TOOLS.arrayFind(g[t],o)>=3)&&(e.barredString=isNaN(e.barredString)?1:e.barredString+1),e.frettedNotes++}}let i={tab:g[t],tag:[]};Object.getOwnPropertyNames(f).forEach((t,r)=>{O(f[t],e)&&i.tag.indexOf(t)&&i.tag.push(t)}),c.push(i)}if(e>0&&e<g[t].length&&c.length===e){r=t+1;break}}}catch(t){console.error(t)}return h.chordList=c,h.offset=r,h}getChordLayout(t,e){let r,o,i=this.fretsToDisplay;try{r=TAB.isValid(e)?PARSER.splitTab(e):[0,0,0,0,0,0]}catch(t){return!1}let n=[];for(let t=0;t<r.length;t++)!1===isNaN(r[t])&&n.push(r[t]);let s=Math.abs(Math.max.apply(Math,n)),l=Math.abs(Math.min.apply(Math,n)),a=1;s>=i&&(a=l>0?l:1),1===a&&s>5&&(a=s-i+2);try{if(0===i)i=s-a+2;else if(s-a+1>i-1)throw i=s-a+2,WORDING.croppedChordLayout}catch(t){console.error(t)}o='<table class="chord">';for(let t=0;t<i;t++){let e=t+a-1;1===a&&0===t&&(o+="<thead>"),o+=e%2&&e>0?'<tr><th class="fret-number">'+e+"</th>":"<tr><th></th>";for(let e=0;e<this.tuning.length;e++){let i=parseInt(r[e]);o+=0===t?0===i?'<th><div class="dot open"></div></th>':"<th></th>":i===a+t-1?'<td><div class="dot plain">'+r[e]+"</div></td>":"<td></td>"}o+=1===a&&0===t?"<tr></thead>":"</tr>"}return o+='<caption align="bottom">'+t+"</caption>",o+="</table>"}}const isValidTab=TAB.isValid,isValidTuning=TUNING.isValid;export{Instrument,isValidTab,isValidTuning};