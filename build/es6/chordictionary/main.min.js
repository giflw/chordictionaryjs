import{WORDING}from"./wordings";import{MDL_A_SCALE}from"./scales";import{MDL_CHORD_FORMULAS}from"./chords";import{splitTuning,splitChordName}from"./parser";import{removeDuplicates,searchInObject,arrayFind,occurrences,countOccurences}from"./tools";class Instrument{constructor(t,e,r,o){try{this.isValidTuning(t)&&(this.tuning=splitTuning(t)),this.fretNumber=e,this.fretsToDisplay=isNaN(r)?0:r+1,this.maxSpan=isNaN(o)?4:o}catch(t){return console.error(t),!1}return this}getChordInfo(t){let e,r,o=[],n=[],i=[],s={error:"",name:"",tab:t,notes:"",tuning:this.tuning.join(""),formula:""};try{this.isValidTab(t)&&(t=splitTab(t))}catch(t){return s.error=t,s}try{for(let n=0;n<t.length;n++)isNaN(t[n])?o.push("x"):(r=this.tuning[n],(e=parseInt(t[n])+MDL_A_SCALE.indexOf(r))>MDL_A_SCALE.length-1&&(e-=MDL_A_SCALE.length),o.push(MDL_A_SCALE[e]));s.notes=o.join("")}catch(t){return s.error=WORDING.failedToConvertTabIntoNotes,s}let l=[];try{for(let t=0;t<this.tuning.length;t++)if(l.push({root:"",formula:[]}),o[t]&&"x"!==o[t].toLowerCase())for(let e=0;e<o.length;e++){if(!o[e]||"x"===o[e].toLowerCase())continue;let r=MDL_A_SCALE.indexOf(o[e])-MDL_A_SCALE.indexOf(o[t]);r<0?r=MDL_A_SCALE.length+r:0===r&&(l[t].root=o[e]),l[t].formula.push(r)}}catch(t){s.error=WORDING.failedToCalculateFormula}for(let t=0;t<l.length;t++){if(""===l[t].root)continue;i.push(l[t].root),l[t].formula.sort(function(t,e){return t-e});let e=removeDuplicates(l[t].formula);n.push(e.join("-"))}let h,a,f=[],u=[];try{for(let t=0;t<MDL_CHORD_FORMULAS.length;t++){h=MDL_CHORD_FORMULAS[t].integer;for(let e=0;e<n.length;e++)a=new RegExp("^"+n[e]+"$","g"),h.match(a)&&i[e]&&(u.push(i[e]+MDL_CHORD_FORMULAS[t].suffix),f.push(MDL_CHORD_FORMULAS[t].formula))}if(!(f.length>0))throw WORDING.noMatch;if(f.length>1){let t=removeDuplicates(f);s.formula=t}else s.formula=f}catch(t){return s.error=t,s}if(u.length>1){let t=removeDuplicates(u);s.name=t}else s.name=u;return s}getChordsList(t,e,r){r=r||0;let o,n,i,s,l=[],h=[],a={error:"",chordList:[],offset:0};const f={basic:{rootBelow4thFret:!0,noMuteAfterFirstNote:!0,rootIsLowestNote:!0,splittedChord:!1,openString:!0},powerchord:{frettedNotes:[2,3],rootIsLowestNote:!0,rootOnLowestFret:!0,splittedChord:!1,openString:!1},bar:{rootIsLowestNote:!0,rootOnLowestFret:!0,barredString:[3,6],noMuteAfterFirstNote:!0,splittedChord:!1,openString:!1}};try{if("string"!=typeof t)throw WORDING.invalidChordName;i=(t=splitChordName(t))[0],o=t[1],l.push(i),s=MDL_A_SCALE.indexOf(i),h=(n=searchInObject(MDL_CHORD_FORMULAS,o)).integer.split("-")}catch(t){return a.error=WORDING.invalidChordName,a}for(let t=1;t<h.length;t++){let e=parseInt(h[t])+parseInt(s);e>MDL_A_SCALE.length-1&&(e-=MDL_A_SCALE.length),l.push(MDL_A_SCALE[e])}let u,g=[],p=0;for(p=0;p<this.tuning.length;p++){g[p]=[],g[p].push("x");for(let t=0;t<l.length;t++)(u=MDL_A_SCALE.indexOf(l[t])-MDL_A_SCALE.indexOf(this.tuning[p]))<0&&(u=MDL_A_SCALE.length+u),g[p].push(u),u+12<this.fretNumber&&g[p].push(u+12)}let c=[];for(p=0;p<this.tuning.length;p++){let t=c.length;for(let e=0;e<g[p].length;e++)if(c[e])for(let r=0;r<t;r++)if(0===e)c[r].push(g[p][e]);else{let t=c[r].slice(0);t.pop(),t.push(g[p][e]),c.push(t)}else c[e]=[g[p][e]]}let d=[],L=(t,e)=>{for(let r in t){if(!e.hasOwnProperty(r))return!1;if("object"==typeof t[r]){let o=t[r][0],n=t[r][1];if(e[r]<o||e[r]>n)return!1}else if(e[r]!==t[r])return!1}return!0};try{for(let t=r;t<c.length;t++){if(isValidChord(c[t],l,this.tuning)&&arrayFind(c[t],"max")-arrayFind(c[t],"min")<this.maxSpan){let e={openString:!1,frettedNotes:0},r=c[t].join(""),o=/[0-9]+[x]+/gi;/[0-9]+[x]+[0-9]+/gi.test(r)?e.splittedChord=!0:e.splittedChord=!1,o.test(r)?e.noMuteAfterFirstNote=!1:e.noMuteAfterFirstNote=!0;for(let r=0;r<c[t].length;r++){let o=c[t][r];if(!isNaN(o)){let n=o+MDL_A_SCALE.indexOf(this.tuning[r]);0===o&&(e.openString=!0),s===n&&(0===e.frettedNotes&&(e.rootIsLowestNote=!0),e.rootBelow4thFret=o<=4,e.rootOnLowestFret=arrayFind(c[t],"min")>=o),(o>0&&r<c[t].length-1&&o===c[t][r-1]||arrayFind(c[t],o)>=3)&&(e.barredString=isNaN(e.barredString)?1:e.barredString+1),e.frettedNotes++}}let n={tab:c[t],tag:[]};Object.getOwnPropertyNames(f).forEach((t,r)=>{L(f[t],e)&&n.tag.indexOf(t)&&n.tag.push(t)}),d.push(n)}if(e>0&&e<c[t].length&&d.length===e){r=t+1;break}}}catch(t){console.error(t)}return a.chordList=d,a.offset=r,a}getChordLayout(t,e){let r,o,n=this.fretsToDisplay;try{r=this.isValidTab(e)?splitTab(e):[0,0,0,0,0,0]}catch(t){return!1}let i=[];for(let t=0;t<r.length;t++)!1===isNaN(r[t])&&i.push(r[t]);let s=Math.abs(Math.max.apply(Math,i)),l=Math.abs(Math.min.apply(Math,i)),h=1;s>=n&&(h=l>0?l:1),1===h&&s>5&&(h=s-n+2);try{if(0===n)n=s-h+2;else if(s-h+1>n-1)throw n=s-h+2,WORDING.croppedChordLayout}catch(t){console.error(t)}o='<table class="chord">';for(let t=0;t<n;t++){let e=t+h-1;1===h&&0===t&&(o+="<thead>"),o+=e%2&&e>0?'<tr><th class="fret-number">'+e+"</th>":"<tr><th></th>";for(let e=0;e<this.tuning.length;e++){let n=parseInt(r[e]);o+=0===t?0===n?'<th><div class="dot open"></div></th>':"<th></th>":n===h+t-1?'<td><div class="dot plain">'+r[e]+"</div></td>":"<td></td>"}o+=1===h&&0===t?"<tr></thead>":"</tr>"}return o+='<caption align="bottom">'+t+"</caption>",o+="</table>"}isValidTab(t){if(new RegExp("^[x0-9]*$","i").test(t))return!0;throw WORDING.invalidTab}isValidTuning(t){if(new RegExp("^[#a-g]+$","i").test(t))return!0;throw WORDING.invalidTuning}}function isValidChord(t,e,r){let o,n,i={};for(let o=0;o<t.length;o++)if(!isNaN(t[o])){(n=t[o]+MDL_A_SCALE.indexOf(r[o]))>MDL_A_SCALE.length-1&&(n-=MDL_A_SCALE.length);for(let t=0;t<e.length;t++)i[MDL_A_SCALE[n]]?MDL_A_SCALE[n]===MDL_A_SCALE[t]&&i[MDL_A_SCALE[n]]++:i[MDL_A_SCALE[n]]=1}for(let t=0;t<e.length;t++){if(!(e[t]in i)){o=!1;break}o=!0}return o}function splitTab(t,e){e=e||"EADGBE";let r=[];if((t=t.toLowerCase()).length<=e.length)return t.split("");if(t.length===2*e.length){for(let e=0;e<t.length;e++)e%2||r.push(t.slice(e,e+2));return r}if(t.length>e.length){if(arrayFind(t.split(""),"max")>1){for(let e=0;e<t.length;e++)-1!==t.charAt(e).search(/[x02-9]/i)||1===t.charAt(e)&&-1!==t.charAt(e+1).search(/x/i)?r.push(t.slice(e,e+1)):-1===t.charAt(e+1).search(/x/i)&&(r.push(t.slice(e,e+2)),e++);return r}throw WORDING.invalidTab}return!1}export{Instrument};